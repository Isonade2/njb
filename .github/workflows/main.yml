name: Deploy .env to EC2

on:
  push:
    branches:
      - dev

jobs:
  update-env:
    runs-on: ubuntu-latest

    env:
      JWT_ACCESS_EXPIRATION: ${{ secrets.JWT_ACCESS_EXPIRATION }}
      JWT_REFRESH_EXPIRATION: ${{ secrets.JWT_REFRESH_EXPIRATION }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LOCAL_DB_URL: ${{ secrets.LOCAL_DB_URL }}
      LOCAL_DB_USERNAME: ${{ secrets.LOCAL_DB_USERNAME }}
      LOCAL_DB_PASSWORD: ${{ secrets.LOCAL_DB_PASSWORD }}
      SQL_INIT_MODE: ${{ secrets.SQL_INIT_MODE }}
      JPA_DDI: ${{ secrets.JPA_DDI }}
      JPA_DDL_AUTO: ${{ secrets.JPA_DDL_AUTO }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
      NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ— Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 400 private_key.pem

      - name: ğŸ” Test SSH Connection
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@52.79.228.170 "echo 'âœ… SSH connection successful!'"

      - name: ğŸ“‚ Transfer .env file to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@52.79.228.170 << 'EOF'
            echo "ğŸ“‚ Checking and creating app directory..."
            mkdir -p ~/app
            cd ~/app

            echo "ğŸ“ Removing old .env file..."
            rm -f .env

            echo "ğŸ“ Creating new .env file..."
            echo "JWT_ACCESS_EXPIRATION=${{ secrets.JWT_ACCESS_EXPIRATION }}" >> .env
            echo "JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
            echo "LOCAL_DB_URL=${{ secrets.LOCAL_DB_URL }}" >> .env
            echo "LOCAL_DB_USERNAME=${{ secrets.LOCAL_DB_USERNAME }}" >> .env
            echo "LOCAL_DB_PASSWORD=${{ secrets.LOCAL_DB_PASSWORD }}" >> .env
            echo "SQL_INIT_MODE=${{ secrets.SQL_INIT_MODE }}" >> .env
            echo "JPA_DDI=${{ secrets.JPA_DDI }}" >> .env
            echo "JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO }}" >> .env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env
            echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> .env
            echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> .env

            echo "âœ… .env file updated successfully!"
            echo "ğŸ” Checking .env file content..."
            cat .env
          EOF
